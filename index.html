<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>UI Ninjas - Startup Ideas Hub (Single File)</title>
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
<style>
:root{
  --blue:#4a90e2;
  --accent1:#ff7e5f;
  --accent2:#feb47b;
  --portal-bg: rgb(223, 253, 254);
  --card-bg: #b9e2f6;
  --tag-bg: #ffb74d;
  --white:#ffffff;
  --text:#222;
}
*{box-sizing:border-box}
body,html{margin:0;padding:0;font-family:Arial,sans-serif;color:var(--text);background:#f7f9fb;transition:background 300ms ease,color 300ms ease;}
a{color:inherit}

#landingPage{
  display:flex;
  height:100vh;
  width:100vw;
  background: linear-gradient(90deg,
    var(--blue) 0%,
    #5a9be0 15%,
    #7fb7e9 30%,
    #a6d2f3 45%,
    #cfe9fb 60%,
    #eef8ff 80%,
    var(--white) 100%);
  overflow:hidden;
  position:relative;
  transition:background 800ms ease;
}

#languageMenuWrapper{
  position:absolute; top:18px; left:18px; z-index:1200;
}
#languageButton{
  padding:12px 20px; font-size:16px; border:none; border-radius:10px; cursor:pointer;
  color:white; background: linear-gradient(145deg, var(--accent1), var(--accent2));
  box-shadow: 0 6px 18px rgba(0,0,0,0.18); transition: transform 180ms ease, box-shadow 180ms ease;
}
#languageButton:hover{ transform:translateY(-2px) scale(1.03); box-shadow:0 12px 28px rgba(0,0,0,0.22); }

#languageDropdown{
  display:none; position:absolute; top:52px; left:0; min-width:220px; border-radius:10px;
  padding:6px; background:linear-gradient(180deg,#ffffff,#fbfdff); box-shadow:0 18px 40px rgba(0,0,0,0.18);
  backdrop-filter: blur(4px);
}
.lang-option{display:flex;align-items:center;gap:10px;padding:8px;border-radius:8px;cursor:pointer;font-size:14px}
.lang-option:hover{background:rgba(74,144,226,0.06);transform:translateY(-2px);}

#leftSide{flex:1;display:flex;flex-direction:column;justify-content:center;align-items:flex-start;padding-left:50px;color:white;transition:all 300ms ease}
#leftSide h1{font-size:56px;margin-bottom:20px;letter-spacing:0.6px}
#leftSide .lp-buttons{display:flex;gap:12px}
#leftSide button.lp-btn{padding:14px 30px;font-size:18px;border:none;border-radius:10px;color:white;cursor:pointer;background:linear-gradient(145deg,var(--accent1),var(--accent2));box-shadow:0 6px 18px rgba(0,0,0,0.14);transition:transform 180ms ease,box-shadow 180ms ease}
#leftSide button.lp-btn:hover{transform:translateY(-4px) scale(1.03);box-shadow:0 18px 34px rgba(0,0,0,0.2);}

#rightSide{flex:1;display:flex;justify-content:center;align-items:center;overflow:hidden;background:transparent;transition:background 600ms ease}
#rightSide img{width:80%;height:80%;object-fit:cover;cursor:pointer;border-radius:15px;transition:transform 260ms ease,box-shadow 260ms ease}
#rightSide img:hover{transform:scale(1.03);box-shadow:0 12px 36px rgba(0,0,0,0.18)}

#mainPortal,#challengePage{display:none;padding:20px;}
header{background:var(--blue);color:white;text-align:center;padding:16px;font-size:28px;font-weight:700;border-radius:8px;}
.main-container{display:flex;gap:18px;padding:18px 0;height:calc(100vh - 92px);overflow:hidden;}
.form-container,.filter-container,.ideas-container{background:var(--portal-bg);padding:14px;border-radius:10px;box-shadow:0 12px 30px rgba(0,0,0,0.06);overflow:auto}
.form-container{flex:1.5} .filter-container{width:220px;flex-shrink:0} .ideas-container{flex:3;display:flex;flex-direction:column}
.form-group{margin-bottom:12px;position:relative}
label{display:block;font-weight:700;margin-bottom:6px}
input[type="text"],select,textarea,input[type="search"]{width:100%;padding:10px;border-radius:6px;border:1px solid #cfdbe6;font-size:15px}
.error{color:#d32f2f;font-size:13px;position:absolute;top:100%;left:0}
button.submit-btn,button.export-btn{background:var(--blue);color:white;border:none;padding:10px 16px;border-radius:8px;cursor:pointer;margin-top:10px;font-weight:700}
button.submit-btn:hover,button.export-btn:hover{background:#357abd;transform:translateY(-3px)}
.idea-item{background:var(--card-bg);padding:14px;border-radius:10px;margin-bottom:12px;box-shadow:0 8px 20px rgba(0,0,0,0.06);transition:transform 220ms ease,box-shadow 220ms ease,opacity 300ms ease,transform 300ms ease;cursor:default;position:relative}
.idea-item:hover{transform:translateY(-6px);box-shadow:0 18px 40px rgba(0,0,0,0.12)}
.category-tag{display:inline-block;background:var(--tag-bg);padding:4px 8px;border-radius:8px;font-size:12px;margin-left:10px;font-weight:700;color:#3a2b10}
.filters button{display:block;width:100%;margin-bottom:10px;padding:10px;border-radius:8px;border:none;background:var(--blue);color:white;cursor:pointer;font-weight:700}
.filters button:hover{background:#357abd}
#ideasList{overflow-y:auto;flex:1;padding-right:8px;max-height:450px}

.challenge-top{display:flex;gap:10px;align-items:center;margin-bottom:12px}
.challenge-profile{display:flex;gap:8px;align-items:center;padding:10px;background:#fff;border-radius:8px;box-shadow:0 6px 18px rgba(0,0,0,0.06)}
.challenge-identity input{width:120px;padding:8px;border-radius:6px;border:1px solid #cfdbe6;margin-right:8px}
.challenge-questions{margin-bottom:16px}
.challenge-question{background:#eaf6ff;padding:14px;margin-bottom:14px;border-radius:8px}
.challenge-actions{display:flex;gap:8px;align-items:center;margin-top:8px}
.challenge-actions button{padding:8px 12px;border-radius:8px;border:none;background:var(--blue);color:white;cursor:pointer}

.feed{margin-top:12px;display:flex;flex-direction:column;gap:12px;max-height:320px;overflow:auto}
.post{background:#fff;padding:12px;border-radius:10px;box-shadow:0 10px 30px rgba(0,0,0,0.06)}
.post-header{display:flex;justify-content:space-between;align-items:center;gap:8px;margin-bottom:8px}
.post-meta{font-size:13px;color:#555}
.post-body{margin-bottom:8px}
.post-actions{display:flex;gap:8px;align-items:center}
.action-btn{padding:6px 10px;border-radius:8px;border:none;background:#f1f7ff;cursor:pointer}
.action-btn.active{background:#dbeeff}

.comments{margin-top:8px;border-top:1px solid #eef6ff;padding-top:8px}
.comment{font-size:13px;padding:6px;border-radius:6px;background:#fbfeff;margin-bottom:6px}
.comment-input{display:flex;gap:8px;margin-top:8px}
.comment-input input{flex:1;padding:8px;border-radius:6px;border:1px solid #cfe4ff}

.sr-only{position:absolute;left:-9999px}
.marked{background:#fff176;padding:0 3px;border-radius:3px}

.idea-item.invisible{opacity:0;transform:translateY(16px);pointer-events:none}
.idea-item.visible{opacity:1;transform:translateY(0);pointer-events:auto}

#floatingPanel{position:fixed;bottom:22px;right:22px;background:rgba(255,255,255,0.95);border-radius:14px;padding:10px;box-shadow:0 18px 50px rgba(0,0,0,0.12);display:flex;gap:8px;z-index:1300}
.fp-btn{padding:8px 10px;border-radius:8px;border:none;cursor:pointer;font-weight:700;background:var(--blue);color:white;transition:transform 140ms ease}
.fp-btn:hover{transform:translateY(-4px)}

#scrollTopBtn{position:fixed;bottom:22px;left:22px;padding:10px 12px;border-radius:50%;border:none;background:var(--blue);color:white;box-shadow:0 12px 30px rgba(0,0,0,0.14);cursor:pointer;display:none;z-index:1300}

.dark-mode{background:#0d1114;color:#e6eef6}
.dark-mode header{background:#0b63b8}
.dark-mode .form-container,.dark-mode .filter-container,.dark-mode .ideas-container{background:#071126}
.dark-mode input, .dark-mode textarea, .dark-mode select{background:#081224;color:#dce9ff;border:1px solid #15304a}
.dark-mode .idea-item{background:#07203a;color:#e6f3ff}
.dark-mode #floatingPanel{background:rgba(6,18,30,0.9)}

#suggestBox{position:absolute;background:#ffffff;border:1px solid #cfe4ff;border-radius:8px;padding:6px;box-shadow:0 12px 30px rgba(0,0,0,0.08);z-index:1400;max-height:220px;overflow:auto;width:100%}
.suggestion{padding:8px;border-radius:6px;cursor:pointer;font-size:14px}
.suggestion:hover{background:#eef7ff}

@media (max-width:900px){
  #leftSide h1{font-size:42px}
  .main-container{flex-direction:column;height:auto}
  #languageMenuWrapper{left:12px}
  #floatingPanel{right:12px;bottom:14px}
}
</style>
</head>
<body id="rootBody">

<div id="landingPage" role="main" aria-label="Landing Page">
  <div id="languageMenuWrapper">
    <button id="languageButton" onclick="toggleLanguageMenu()">Language üåê</button>
    <div id="languageDropdown" aria-hidden="true">
      <div class="lang-option" onclick="smoothLanguageSwitch('English')"><span>üá¨üáß</span><strong style="margin-left:8px">English</strong><span style="margin-left:auto;font-size:12px;color:#777">Default</span></div>
      <div class="lang-option" onclick="smoothLanguageSwitch('Hindi')"><span>üáÆüá≥</span><strong style="margin-left:8px">‡§π‡§ø‡§Ç‡§¶‡•Ä</strong><span style="margin-left:auto;font-size:12px;color:#777">Popular</span></div>
      <div class="lang-option" onclick="smoothLanguageSwitch('Telugu')"><span>üáÆüá≥</span><strong style="margin-left:8px">‡∞§‡±Ü‡∞≤‡±Å‡∞ó‡±Å</strong><span style="margin-left:auto;font-size:12px;color:#777">Local</span></div>
    </div>
  </div>

  <div id="leftSide">
    <h1 id="brandTitle">UI Ninjas ‚ú®üí°üöÄ</h1>
    <div class="lp-buttons">
      <button class="lp-btn" id="openBtn" onclick="openPortal()">Open</button>
      <button class="lp-btn" id="challengeBtn" onclick="openChallenge()">Challenge</button>
    </div>
  </div>
  <div id="rightSide">
    <img src="https://via.placeholder.com/700x500?text=Team+Photo" alt="Team Photo" onclick="alert('You clicked the photo!')">
  </div>
</div>

<div id="mainPortal" aria-hidden="true">
  <header id="mainHeader">üí° Student Startup Ideas Hub</header>

  <div style="display:flex; justify-content:flex-end; margin:12px 0;">
    <button id="backBtnPortal" onclick="backToLanding()" style="padding:8px 12px;border-radius:8px;border:1px solid #ddd;background:#fff;color:#333;cursor:pointer">‚Üê Back</button>
  </div>

  <div class="main-container">

    <div class="form-container" id="formContainer">
      <h2 id="formTitle">Submit Problem & Idea (Question Paper)</h2>

      <div class="form-group">
        <label id="labelName">Name *</label>
        <input type="text" id="studentName" autocomplete="name">
        <span class="error" id="nameError"></span>
      </div>

      <div class="form-group">
        <label id="labelClass">Class (1-10) *</label>
        <input type="text" id="studentClass" inputmode="numeric">
        <span class="error" id="classError"></span>
      </div>

      <div class="form-group">
        <label id="labelSection">Section *</label>
        <input type="text" id="studentSection">
        <span class="error" id="sectionError"></span>
      </div>

      <div class="form-group">
        <label id="labelProblem">Problem *</label>
        <textarea id="problemText" rows="3" maxlength="200"></textarea>
        <span class="error" id="problemError"></span>
      </div>

      <div class="form-group">
        <label id="labelIdea">Idea (Optional) ‚Äî will NOT appear in posts</label>
        <textarea id="ideaText" rows="3" maxlength="200"></textarea>
        <span class="error" id="ideaError"></span>
      </div>

      <div class="form-group">
        <label id="labelCategory">Category *</label>
        <select id="category">
          <option value="Technology">Technology</option>
          <option value="Health">Health</option>
          <option value="Education">Education</option>
          <option value="Environment">Environment</option>
        </select>
      </div>

      <button class="submit-btn" id="submitBtn" onclick="submitQuestion()">Submit</button>
      <button class="export-btn" id="exportBtn" onclick="exportToExcel()">Export to Excel</button>

    </div>

    <div class="filter-container">
      <h3 id="filterTitle">Filters</h3>
      <div class="filters">
        <button id="filterAll" onclick="applyFilter('All')">All</button>
        <button id="filterTech" onclick="applyFilter('Technology')">Technology</button>
        <button id="filterHealth" onclick="applyFilter('Health')">Health</button>
        <button id="filterEdu" onclick="applyFilter('Education')">Education</button>
        <button id="filterEnv" onclick="applyFilter('Environment')">Environment</button>
      </div>
    </div>

    <div class="ideas-container">
      <h2 id="ideasTitle">Saved Questions (Question Paper)</h2>

      <div style="display:flex;align-items:center;gap:8px;position:relative;margin-bottom:8px;">
        <button title="Search" onclick="searchQuestions()" style="padding:10px 14px;font-size:18px;">‚Üê</button>
        <div style="flex:1;position:relative;">
          <input type="search" id="searchBar" placeholder="Search problems..." oninput="onSearchInput()" style="width:100%;padding:10px;border-radius:6px;border:1px solid #cfdbe6">
          <div id="suggestBox" style="display:none"></div>
        </div>
      </div>

      <div id="ideasList" aria-live="polite"></div>

      <h3 style="margin-top:12px;margin-bottom:8px;">Live Feed (Posts)</h3>
      <div id="portalFeed" class="feed"></div>

    </div>

  </div>
</div>

<div id="challengePage" aria-hidden="true">
  <header id="challengeHeader">üî• Challenge Mode</header>

  <div class="challenge-top">
    <div class="challenge-profile">
      <div style="font-weight:700;margin-right:8px;">Profile</div>
      <div class="challenge-identity">
        <input id="cpName" placeholder="Name">
        <input id="cpClass" placeholder="Class">
        <input id="cpSection" placeholder="Section">
      </div>
    </div>

    <div style="margin-left:auto;display:flex;gap:8px;align-items:center;">
      <button class="challenge-actions" id="backChallengeBtn" onclick="backToLanding()" style="background:#fff;border-radius:8px;padding:8px 12px;border:1px solid #ddd;cursor:pointer">‚Üê Back</button>
      <button class="challenge-actions" id="submitAllBtn" onclick="submitAllAnswers()" style="background:var(--blue);color:#fff;border-radius:8px;padding:8px 12px;border:none;cursor:pointer">Submit All</button>
    </div>
  </div>

  <div id="challengeQuestionsContainer" class="challenge-questions"></div>

  <h3 style="margin-top:8px;margin-bottom:6px;">Live Feed (Posts)</h3>
  <div style="margin-bottom:8px;">
    <input id="feedSearch" placeholder="Search across all posts..." style="width:100%;padding:10px;border-radius:6px;border:1px solid #cfdbe6" oninput="onFeedSearchInput()">
  </div>

  <div id="feed" class="feed"></div>

</div>

<div id="floatingPanel" aria-hidden="false">
  <button class="fp-btn" onclick="applyFilter('All')">All</button>
  <button class="fp-btn" onclick="applyFilter('Technology')">Tech</button>
  <button class="fp-btn" onclick="openPortal()">New</button>
  <button class="fp-btn" onclick="exportToExcel()">Export</button>
  <button class="fp-btn" id="themeToggle" onclick="toggleDarkMode()">Dark</button>
</div>
<button id="scrollTopBtn" title="Scroll to top" onclick="scrollToTop()">‚Üë</button>

<script>
const QUESTIONS_KEY = 'ui_questions_v1';
const POSTS_KEY = 'ui_posts_v1';
const LANG_KEY = 'ui_ninjas_lang';
const DARK_KEY = 'ui_ninjas_dark';
const USER_KEY = 'ui_ninjas_userid';

const landingPage = document.getElementById('landingPage');
const mainPortal = document.getElementById('mainPortal');
const challengePage = document.getElementById('challengePage');
const ideasList = document.getElementById('ideasList');
const portalFeed = document.getElementById('portalFeed');
const feed = document.getElementById('feed');
const searchBar = document.getElementById('searchBar');
const feedSearch = document.getElementById('feedSearch');
const suggestBox = document.getElementById('suggestBox');

let currentLang = localStorage.getItem(LANG_KEY) || 'English';
let activeFilter = 'All';

(function ensureUser(){
  if(!localStorage.getItem(USER_KEY)){
    localStorage.setItem(USER_KEY, 'u_'+Math.random().toString(36).slice(2,9));
  }
})();
const currentUser = localStorage.getItem(USER_KEY);

const TRANSLATIONS = {
  English: {
    languageButton:'Language üåê', openBtn:'Open', challengeBtn:'Challenge', mainHeader:'üí° Student Startup Ideas Hub',
    formTitle:'Submit Problem & Idea', labelName:'Name *', labelClass:'Class (1-10) *', labelSection:'Section *',
    labelProblem:'Problem *', labelIdea:'Idea (Optional)', labelCategory:'Category *', submitBtn:'Submit',
    exportBtn:'Export to Excel', filterTitle:'Filters',
    filters:{All:'All', Technology:'Technology', Health:'Health', Education:'Education', Environment:'Environment'},
    ideasTitle:'Problems & Ideas', searchPlaceholder:'Search problems or ideas...', challengeHeader:'üî• Challenge Mode',
    backBtn:'Back', skipText:'Skip', challengeAnswerPlaceholder:'Write your answer here...',
    errors:{required:'Required', invalidClass:'Invalid class (1-10)', maxChars:'Max 200 characters'},
    ideaLabel:'Idea:', problemLabel:'Problem:', submitAnswer:'Submit', submitAll:'Submit All', like:'Like', comment:'Comment', placeholderComment:'Write a comment...'
  }
};

function loadQuestions(){
  try{ return JSON.parse(localStorage.getItem(QUESTIONS_KEY) || '[]'); }catch(e){return [];}
}
function saveQuestions(qs){ localStorage.setItem(QUESTIONS_KEY, JSON.stringify(qs)); }
function loadPosts(){
  try{ return JSON.parse(localStorage.getItem(POSTS_KEY) || '[]'); }catch(e){return [];}
}
function savePosts(ps){ localStorage.setItem(POSTS_KEY, JSON.stringify(ps)); }

function validateClass(cls){ const n = parseInt(cls,10); return !isNaN(n) && n>=1 && n<=10; }

function submitQuestion(){
  const name = document.getElementById('studentName').value.trim();
  const sClass = document.getElementById('studentClass').value.trim();
  const section = document.getElementById('studentSection').value.trim();
  const problem = document.getElementById('problemText').value.trim();
  const idea = document.getElementById('ideaText').value.trim();
  const category = document.getElementById('category').value;
  document.getElementById('nameError').textContent=''; document.getElementById('classError').textContent=''; document.getElementById('sectionError').textContent=''; document.getElementById('problemError').textContent=''; document.getElementById('ideaError').textContent='';
  const errs = TRANSLATIONS[currentLang].errors;
  let ok=true;
  if(!name){ document.getElementById('nameError').textContent=errs.required; ok=false; }
  if(!validateClass(sClass)){ document.getElementById('classError').textContent=errs.invalidClass; ok=false; }
  if(!section){ document.getElementById('sectionError').textContent=errs.required; ok=false; }
  if(!problem){ document.getElementById('problemError').textContent=errs.required; ok=false; }
  if(problem.length>200){ document.getElementById('problemError').textContent=errs.maxChars; ok=false; }
  if(idea.length>200){ document.getElementById('ideaError').textContent=errs.maxChars; ok=false; }
  if(!ok) return;
  const qs = loadQuestions();
  const id = qs.length ? Math.max(...qs.map(x=>x.id))+1 : 1;
  qs.push({ id, name, sClass, section, problem, idea, category, ts: Date.now() });
  saveQuestions(qs);
  renderAllQuestions();
  document.getElementById('studentName').value=''; document.getElementById('studentClass').value=''; document.getElementById('studentSection').value=''; document.getElementById('problemText').value=''; document.getElementById('ideaText').value=''; document.getElementById('category').value='Technology';
}

function renderQuestionItem(q){
  const wrapper = document.createElement('div');
  wrapper.className = 'idea-item';
  wrapper.setAttribute('data-category', q.category || 'Technology');
  wrapper.setAttribute('data-ts', q.ts || Date.now());
  wrapper.innerHTML = `
    <p><strong>${escapeHtml(q.name)} | Class: ${escapeHtml(q.sClass)} Section: ${escapeHtml(q.section)}</strong></p>
    <p><strong>${escapeHtml((TRANSLATIONS[currentLang]||TRANSLATIONS.English).problemLabel)}</strong> ${escapeHtml(q.problem)}</p>
    <span class="category-tag">${escapeHtml(q.category || 'Technology')}</span>
  `;
  return wrapper;
}
function renderAllQuestions(){
  ideasList.innerHTML = '';
  const qs = loadQuestions();
  qs.forEach(q => ideasList.appendChild(renderQuestionItem(q)));
}

function openChallenge(){
  landingPage.style.display = 'none';
  mainPortal.style.display = 'none';
  challengePage.style.display = 'block';
  renderChallengeQuestions();
  renderFeed();
}
function openPortal(){
  landingPage.style.display = 'none';
  mainPortal.style.display = 'block';
  challengePage.style.display = 'none';
  renderAllQuestions();
  renderFeed();
}
function backToLanding(){
  landingPage.style.display = 'flex';
  mainPortal.style.display = 'none';
  challengePage.style.display = 'none';
}

function renderChallengeQuestions(){
  const container = document.getElementById('challengeQuestionsContainer');
  container.innerHTML = '';
  const qs = loadQuestions();
  const labels = TRANSLATIONS[currentLang] || TRANSLATIONS.English;
  if(qs.length === 0){
    container.innerHTML = `<div class="challenge-question">No questions available.</div>`;
    return;
  }
  qs.forEach((q, idx) => {
    const div = document.createElement('div');
    div.className = 'challenge-question';
    div.innerHTML = `
      <p><strong>Q${idx+1}:</strong> ${escapeHtml(q.problem)}</p>
      <textarea id="answer_${q.id}" placeholder="${escapeHtml(labels.challengeAnswerPlaceholder)}"></textarea>
      <div class="challenge-actions">
        <button onclick="submitSingleAnswer(${q.id})">${escapeHtml(labels.submitAnswer)}</button>
        <button onclick="skipAnswerInline(${q.id})" style="background:#fff;border:1px solid #ddd;color:#333;padding:8px 12px;border-radius:8px;cursor:pointer">${escapeHtml(labels.skipText)}</button>
      </div>
    `;
    container.appendChild(div);
    const ta = document.getElementById(`answer_${q.id}`);
    if(ta) ta.dataset.skipped = 'false';
  });
}

function skipAnswerInline(qId){
  const ta = document.getElementById(`answer_${qId}`);
  const labels = TRANSLATIONS[currentLang] || TRANSLATIONS.English;
  if(ta){
    ta.value = '';
    ta.dataset.skipped = 'true';
    ta.placeholder = labels.skipText || 'Skipped';
  }
}

function submitSingleAnswer(qId){
  const ta = document.getElementById(`answer_${qId}`);
  if(!ta) return alert('Answer area not found.');
  if(ta.dataset.skipped === 'true'){ ta.value=''; return; }
  const answer = ta.value.trim();
  if(!answer) return alert((TRANSLATIONS[currentLang]||TRANSLATIONS.English).errors.required);
  const name = document.getElementById('cpName').value.trim();
  const sClass = document.getElementById('cpClass').value.trim();
  const section = document.getElementById('cpSection').value.trim();
  if(!name || !sClass || !section) return alert((TRANSLATIONS[currentLang]||TRANSLATIONS.English).errors.required);
  const qs = loadQuestions();
  const q = qs.find(x=>x.id === qId);
  if(!q) return alert('Question not found.');
  const posts = loadPosts();
  const newId = posts.length ? Math.max(...posts.map(p=>p.id))+1 : 1;
  const post = {
    id: newId,
    responderName: name,
    responderClass: sClass,
    responderSection: section,
    problem: q.problem,
    answer,
    likes: 0,
    likedBy: [],
    comments: [],
    ts: Date.now()
  };
  posts.push(post);
  savePosts(posts);
  ta.value = '';
  ta.dataset.skipped = 'false';
  renderFeed();
  renderPortalFeed();
}

function submitAllAnswers(){
  const name = document.getElementById('cpName').value.trim();
  const sClass = document.getElementById('cpClass').value.trim();
  const section = document.getElementById('cpSection').value.trim();
  if(!name || !sClass || !section) return alert((TRANSLATIONS[currentLang]||TRANSLATIONS.English).errors.required);
  const qs = loadQuestions();
  let any = false;
  const posts = loadPosts();
  qs.forEach(q => {
    const ta = document.getElementById(`answer_${q.id}`);
    if(ta && ta.dataset.skipped === 'true') return;
    if(ta && ta.value.trim()){
      const newId = posts.length ? Math.max(...posts.map(p=>p.id))+1 : 1 + posts.length;
      const post = {
        id: newId,
        responderName: name,
        responderClass: sClass,
        responderSection: section,
        problem: q.problem,
        answer: ta.value.trim(),
        likes: 0,
        likedBy: [],
        comments: [],
        ts: Date.now()
      };
      posts.push(post);
      any = true;
      ta.value = '';
      ta.dataset.skipped = 'false';
    }
  });
  if(!any) return alert('No answers to submit');
  savePosts(posts);
  renderFeed();
  renderPortalFeed();
  alert('Answers submitted');
}

function renderFeed(filteredPosts){
  const posts = (filteredPosts || loadPosts()).slice();
  posts.sort((a,b)=> {
    const la = (a.likedBy && a.likedBy.length) || a.likes || 0;
    const lb = (b.likedBy && b.likedBy.length) || b.likes || 0;
    if(lb !== la) return lb - la;
    return b.ts - a.ts;
  });
  feed.innerHTML = '';
  posts.forEach(p => feed.appendChild(createPostCard(p)));
  renderPortalFeed();
}
function renderPortalFeed(){
  const posts = loadPosts().slice();
  posts.sort((a,b)=> {
    const la = (a.likedBy && a.likedBy.length) || a.likes || 0;
    const lb = (b.likedBy && b.likedBy.length) || b.likes || 0;
    if(lb !== la) return lb - la;
    return b.ts - a.ts;
  });
  portalFeed.innerHTML = '';
  posts.forEach(p => portalFeed.appendChild(createPostCard(p)));
}

function createPostCard(p){
  const labels = TRANSLATIONS[currentLang] || TRANSLATIONS.English;
  const card = document.createElement('div');
  card.className = 'post';
  card.dataset.id = p.id;
  const time = new Date(p.ts).toLocaleString();
  const likeCount = (p.likedBy && p.likedBy.length) || p.likes || 0;
  card.innerHTML = `
    <div class="post-header">
      <div>
        <div style="font-weight:700">${escapeHtml(p.responderName)} ‚Äî ${escapeHtml(p.responderClass)}/${escapeHtml(p.responderSection)}</div>
        <div class="post-meta">${escapeHtml(p.problem)}</div>
      </div>
      <div style="font-size:12px;color:#666">${escapeHtml(time)}</div>
    </div>
    <div class="post-body">${escapeHtml(p.answer)}</div>
    <div class="post-actions">
      <button class="action-btn like-btn" data-id="${p.id}">${escapeHtml(labels.like)} (${likeCount})</button>
      <button class="action-btn comment-btn" data-id="${p.id}">${escapeHtml(labels.comment)}</button>
    </div>
    <div class="comments" id="comments_${p.id}" style="display:none"></div>
  `;
  const likeBtn = card.querySelector('.like-btn');
  likeBtn.addEventListener('click', ()=> {
    const posts = loadPosts();
    const idx = posts.findIndex(x => x.id === p.id);
    if(idx >= 0){
      posts[idx].likedBy = posts[idx].likedBy || [];
      if(!posts[idx].likedBy.includes(currentUser)){
        posts[idx].likedBy.push(currentUser);
        posts[idx].likes = posts[idx].likedBy.length;
        savePosts(posts);
        likeBtn.innerText = `${(TRANSLATIONS[currentLang]||TRANSLATIONS.English).like} (${posts[idx].likes})`;
        likeBtn.disabled = true;
        likeBtn.style.opacity = 0.6;
        renderFeed();
      } else {
        alert('You already liked this post!');
      }
    }
  });
  try{
    const postsNow = loadPosts();
    const currentPost = postsNow.find(x=>x.id===p.id);
    if(currentPost && currentPost.likedBy && currentPost.likedBy.includes(currentUser)){
      likeBtn.disabled = true;
      likeBtn.style.opacity = 0.6;
    }
  }catch(e){}

  const commentBtn = card.querySelector('.comment-btn');
  commentBtn.addEventListener('click', ()=> { toggleCommentsUI(p.id); });
  const commentsDiv = card.querySelector(`#comments_${p.id}`);
  if(p.comments && p.comments.length){
    p.comments.forEach(c=>{
      const cdiv = document.createElement('div');
      cdiv.className = 'comment';
      cdiv.innerHTML = `<div style="font-size:12px;color:#333">${escapeHtml(c.text)}</div><div style="font-size:11px;color:#666">${new Date(c.ts).toLocaleString()}</div>`;
      commentsDiv.appendChild(cdiv);
    });
  }
  return card;
}

function toggleCommentsUI(postId){
  const commentElems = Array.from(document.querySelectorAll(`#comments_${postId}`));
  if(commentElems.length === 0) return;
  commentElems.forEach(commentsDiv => {
    if(!commentsDiv) return;
    if(commentsDiv.style.display === 'block'){ commentsDiv.style.display = 'none'; return; }
    commentsDiv.innerHTML = '';
    const posts = loadPosts();
    const post = posts.find(x=>x.id === postId);
    if(post && post.comments && post.comments.length){
      post.comments.forEach(c => {
        const cdiv = document.createElement('div');
        cdiv.className = 'comment';
        cdiv.innerHTML = `<div style="font-size:13px">${escapeHtml(c.text)}</div><div style="font-size:11px;color:#666">${new Date(c.ts).toLocaleString()}</div>`;
        commentsDiv.appendChild(cdiv);
      });
    }
    const inputRow = document.createElement('div');
    inputRow.className = 'comment-input';
    inputRow.innerHTML = `<input id="c_in_${postId}" placeholder="${escapeHtml((TRANSLATIONS[currentLang]||TRANSLATIONS.English).placeholderComment)}"><button style="padding:8px 10px;border-radius:6px;border:none;background:var(--blue);color:#fff;cursor:pointer">Post</button>`;
    const postBtn = inputRow.querySelector('button');
    postBtn.addEventListener('click', ()=> {
      const val = inputRow.querySelector('input').value.trim();
      if(!val) { alert('Empty comment'); return; }
      addCommentToPost(postId, val);
      renderFeed();
    });
    commentsDiv.appendChild(inputRow);
    commentsDiv.style.display = 'block';
  });
}

function addCommentToPost(postId, text){
  const posts = loadPosts();
  const idx = posts.findIndex(x=>x.id === postId);
  if(idx === -1) return;
  posts[idx].comments = posts[idx].comments || [];
  posts[idx].comments.push({ id: 'c_'+Math.random().toString(36).slice(2,9), text, ts: Date.now() });
  savePosts(posts);
  renderFeed();
}

function applyFilter(category){ activeFilter = category; renderFeed(); }

function onSearchInput(){
  const q = (searchBar.value || '').trim();
  showSuggestions(q);
  searchQuestions();
}
function showSuggestions(query){
  const q = (query || '').toLowerCase().trim();
  if(!q){ suggestBox.style.display='none'; suggestBox.innerHTML=''; return; }
  const set = new Set();
  loadQuestions().forEach(p=>{ if((p.problem||'').toLowerCase().includes(q)) set.add(p.problem); });
  const arr = Array.from(set).slice(0,10);
  if(arr.length===0){ suggestBox.style.display='none'; suggestBox.innerHTML=''; return; }
  suggestBox.innerHTML = arr.map(s=>`<div class="suggestion" onclick="applySuggestion(this)">${escapeHtml(s)}</div>`).join('');
  suggestBox.style.display='block';
}
function applySuggestion(el){ if(!el) return; document.getElementById('searchBar').value = el.innerText; suggestBox.style.display='none'; searchQuestions(); }
function searchQuestions(){
  const searchTerm = (searchBar.value || '').toLowerCase().trim().split(/\s+/).filter(Boolean);
  const allEntries = document.querySelectorAll('.idea-item');
  allEntries.forEach(div=>{
    const matchesFilter = (activeFilter === 'All') || (div.getAttribute('data-category') === activeFilter);
    const problemText = div.querySelector('p:nth-child(2)') ? div.querySelector('p:nth-child(2)').innerText.toLowerCase() : '';
    const fullText = (problemText).toLowerCase();
    if(searchTerm.length === 0){ div.style.display = matchesFilter ? 'block' : 'none'; return; }
    let matchCount = 0;
    searchTerm.forEach(word => { if(fullText.includes(word)) matchCount++; });
    const matchesSearch = matchCount >= Math.ceil(searchTerm.length / 2);
    div.style.display = (matchesFilter && matchesSearch) ? 'block' : 'none';
  });
}

function onFeedSearchInput(){
  const q = (feedSearch.value || '').trim().toLowerCase();
  if(!q){ renderFeed(); return; }
  const terms = q.split(/\s+/).filter(Boolean);
  const posts = loadPosts();
  const scored = posts.map(p=>{
    let text = ((p.problem||'') + ' ' + (p.answer||'') + ' ' + (p.responderName||'')).toLowerCase();
    let score = 0;
    terms.forEach(t => { if(t && text.indexOf(t) !== -1) score++; });
    return { p, score };
  }).filter(x=>x.score>0)
    .sort((a,b)=> {
      if(b.score !== a.score) return b.score - a.score;
      const la = (a.p.likedBy && a.p.likedBy.length) || a.p.likes || 0;
      const lb = (b.p.likedBy && b.p.likedBy.length) || b.p.likes || 0;
      if(lb !== la) return lb - la;
      return b.p.ts - a.p.ts;
    }).map(x=>x.p);
  renderFeed(scored);
}

function exportToExcel(){
  const posts = loadPosts();
  const qs = loadQuestions();
  const qb = qs.map(q=>({ id: q.id, name: q.name, class: q.sClass, section: q.section, problem: q.problem, idea: q.idea, category: q.category, ts: new Date(q.ts).toLocaleString() }));
  const pb = posts.map(p=>({ id: p.id, responderName: p.responderName, class: p.responderClass, section: p.responderSection, problem: p.problem, answer: p.answer, likes: (p.likedBy && p.likedBy.length) || p.likes || 0, comments: (p.comments||[]).map(c=>c.text).join(' | '), ts: new Date(p.ts).toLocaleString() }));
  const wb = XLSX.utils.book_new();
  if(qb.length){ const ws1 = XLSX.utils.json_to_sheet(qb); XLSX.utils.book_append_sheet(wb, ws1, 'Questions'); }
  if(pb.length){ const ws2 = XLSX.utils.json_to_sheet(pb); XLSX.utils.book_append_sheet(wb, ws2, 'Posts'); }
  if(!wb.SheetNames.length){ alert('No data to export'); return; }
  XLSX.writeFile(wb, 'UI_Ninjas_Data.xlsx');
}

function escapeHtml(str){ return String(str||'').replace(/[&<>"']/g, s=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[s])); }

function toggleLanguageMenu(){
  const m = document.getElementById('languageDropdown');
  m.style.display = (m.style.display === 'block') ? 'none' : 'block';
  m.setAttribute('aria-hidden', m.style.display === 'block' ? 'false' : 'true');
}
function smoothLanguageSwitch(lang){
  const dd = document.getElementById('languageDropdown');
  dd.style.display = 'none';
  localStorage.setItem(LANG_KEY, lang);
  currentLang = lang;
}

function toggleDarkMode(){
  const root = document.getElementById('rootBody');
  root.classList.toggle('dark-mode');
  const on = root.classList.contains('dark-mode');
  document.getElementById('themeToggle').innerText = on ? 'Light' : 'Dark';
  localStorage.setItem(DARK_KEY, on ? '1' : '0');
}
function scrollToTop(){ window.scrollTo({ top:0, behavior:'smooth' }); }
window.addEventListener('scroll', ()=> {
  const btn = document.getElementById('scrollTopBtn');
  btn.style.display = window.scrollY > 220 ? 'block' : 'none';
});

(function init(){
  if(localStorage.getItem(DARK_KEY) === '1'){ document.getElementById('rootBody').classList.add('dark-mode'); document.getElementById('themeToggle').innerText = 'Light'; }
  landingPage.style.display = 'flex';
  mainPortal.style.display = 'none';
  challengePage.style.display = 'none';
  renderAllQuestions();
  renderFeed();
  document.addEventListener('click', function(ev){
    const ld = document.getElementById('languageDropdown');
    const lw = document.getElementById('languageMenuWrapper');
    if(ld && lw && !lw.contains(ev.target)) ld.style.display='none';
    if(suggestBox && !suggestBox.contains(ev.target) && ev.target !== searchBar) { suggestBox.style.display='none'; }
  });
})();
</script>
</body>
</html>

